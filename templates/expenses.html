<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Despesas - Sistema de Gest√£o Financeira</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin: 0;
        }
        .back-link {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: #667eea;
            color: white;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card h3 {
            color: #764ba2;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card p {
            color: #667eea;
            font-size: 2em;
            font-weight: bold;
            margin: 0;
        }
        .filters-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .filters-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            color: #764ba2;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .filter-group input:focus,
        .filter-group select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-header h2 {
            color: #667eea;
            font-size: 1.3em;
        }
        .actions-bar {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f8f9fa;
            color: #667eea;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        th:hover {
            background: #e9ecef;
        }
        th.sortable::after {
            content: ' ‚Üï';
            opacity: 0.5;
        }
        th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }
        th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-custos-fixos { background: #3498db; color: white; }
        .badge-conforto { background: #2ecc71; color: white; }
        .badge-prazeres { background: #e67e22; color: white; }
        .badge-conhecimento { background: #9b59b6; color: white; }
        .badge-metas { background: #f1c40f; color: #333; }
        .badge-liberdade-financeira { background: #d4af37; color: #333; }
        .badge-categorizar { background: #95a5a6; color: white; }
        .badge-subcategoria {
            background: #ecf0f1;
            color: #333;
            font-size: 0.8em;
        }
        .tag-chip {
            display: inline-block;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin: 2px;
            color: #495057;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-icon {
            padding: 5px 10px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-edit {
            background: #3498db;
            color: white;
        }
        .btn-edit:hover {
            background: #2980b9;
        }
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        .btn-delete:hover {
            background: #c0392b;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination .page-info {
            padding: 8px 15px;
            color: #667eea;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            color: #667eea;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #95a5a6;
        }
        .close-modal:hover {
            color: #667eea;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #764ba2;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .table-container {
                overflow-x: auto;
            }
            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Minhas Despesas</h1>
            <a href="/" class="back-link">‚Üê Voltar para Dashboard</a>
        </div>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <h3>Total de Despesas</h3>
                <p id="statCount">0</p>
            </div>
            <div class="stat-card">
                <h3>Valor Total</h3>
                <p id="statTotal">R$ 0,00</p>
            </div>
            <div class="stat-card">
                <h3>M√©dia por Despesa</h3>
                <p id="statMedia">R$ 0,00</p>
            </div>
        </div>

        <div class="filters-container">
            <h2>üîç Filtros</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Buscar por descri√ß√£o</label>
                    <input type="text" id="filterSearch" placeholder="Digite para buscar...">
                </div>
                <div class="filter-group">
                    <label>Categoria</label>
                    <select id="filterCategoria">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Subcategoria</label>
                    <select id="filterSubcategoria">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Data Inicial</label>
                    <input type="date" id="filterDataInicio">
                </div>
                <div class="filter-group">
                    <label>Data Final</label>
                    <input type="date" id="filterDataFim">
                </div>
                <div class="filter-group">
                    <label>Valor M√≠nimo</label>
                    <input type="number" id="filterValorMin" step="0.01" placeholder="0.00">
                </div>
                <div class="filter-group">
                    <label>Valor M√°ximo</label>
                    <input type="number" id="filterValorMax" step="0.01" placeholder="0.00">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary" onclick="clearFilters()">Limpar Filtros</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h2>üìã Despesas</h2>
                <div class="actions-bar">
                    <button class="btn btn-primary" onclick="exportCSV()">üì• Exportar CSV</button>
                    <a href="/" class="btn btn-primary">‚ûï Nova Despesa</a>
                </div>
            </div>
            <div id="loading" class="loading">Carregando despesas...</div>
            <div id="tableWrapper" style="display: none;">
                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="data" onclick="sortTable('data')">Data</th>
                            <th class="sortable" data-sort="descricao" onclick="sortTable('descricao')">Descri√ß√£o</th>
                            <th class="sortable" data-sort="valor" onclick="sortTable('valor')">Valor</th>
                            <th>Categoria</th>
                            <th>Subcategoria</th>
                            <th>Tags</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody">
                    </tbody>
                </table>
                <div class="pagination" id="pagination">
                </div>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>Nenhuma despesa encontrada</h3>
                <p>Tente ajustar os filtros ou adicione uma nova despesa.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Despesa</h3>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editIndex">
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="editData" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="editDescricao" required>
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="editValor" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="editCategoria" required>
                        <option value="CUSTOS FIXOS">CUSTOS FIXOS</option>
                        <option value="CONFORTO">CONFORTO</option>
                        <option value="METAS">METAS</option>
                        <option value="PRAZERES">PRAZERES</option>
                        <option value="LIBERDADE FINANCEIRA">LIBERDADE FINANCEIRA</option>
                        <option value="CONHECIMENTO">CONHECIMENTO</option>
                        <option value="CATEGORIZAR">CATEGORIZAR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subcategoria</label>
                    <input type="text" id="editSubcategoria">
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <input type="text" id="editTags">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentLimit = 50;
        let currentSort = 'data';
        let currentSortOrder = 'desc';
        let allExpenses = [];
        let currentExpenses = [];

        // Carregar despesas ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            loadExpenses();
            setupFilters();
        });

        // Configurar filtros
        function setupFilters() {
            const searchInput = document.getElementById('filterSearch');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadExpenses();
                }, 300);
            });

            ['filterCategoria', 'filterSubcategoria', 'filterDataInicio', 'filterDataFim', 'filterValorMin', 'filterValorMax'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    currentPage = 1;
                    loadExpenses();
                });
            });
        }

        // Carregar despesas
        async function loadExpenses() {
            const loading = document.getElementById('loading');
            const tableWrapper = document.getElementById('tableWrapper');
            const emptyState = document.getElementById('emptyState');
            
            loading.style.display = 'block';
            tableWrapper.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: currentLimit,
                    sort_by: currentSort,
                    sort_order: currentSortOrder
                });

                const search = document.getElementById('filterSearch').value;
                const categoria = document.getElementById('filterCategoria').value;
                const subcategoria = document.getElementById('filterSubcategoria').value;
                const dataInicio = document.getElementById('filterDataInicio').value;
                const dataFim = document.getElementById('filterDataFim').value;
                const valorMin = document.getElementById('filterValorMin').value;
                const valorMax = document.getElementById('filterValorMax').value;

                if (search) params.append('search', search);
                if (categoria) params.append('categoria', categoria);
                if (subcategoria) params.append('subcategoria', subcategoria);
                if (dataInicio) params.append('data_inicio', dataInicio);
                if (dataFim) params.append('data_fim', dataFim);
                if (valorMin) params.append('valor_min', valorMin);
                if (valorMax) params.append('valor_max', valorMax);

                const response = await fetch(`/api/expenses?${params}`);
                const data = await response.json();

                if (data.status === 'success') {
                    currentExpenses = data.expenses;
                    allExpenses = data.expenses;
                    
                    updateStats(data.stats);
                    updateTable(data.expenses);
                    updatePagination(data.pagination);
                    populateFilterOptions(data.expenses);

                    loading.style.display = 'none';
                    if (data.expenses.length > 0) {
                        tableWrapper.style.display = 'block';
                    } else {
                        emptyState.style.display = 'block';
                    }
                } else {
                    throw new Error(data.message || 'Erro ao carregar despesas');
                }
            } catch (error) {
                loading.style.display = 'none';
                alert('Erro ao carregar despesas: ' + error.message);
            }
        }

        // Atualizar estat√≠sticas
        function updateStats(stats) {
            document.getElementById('statCount').textContent = stats.count;
            document.getElementById('statTotal').textContent = formatCurrency(stats.total);
            document.getElementById('statMedia').textContent = formatCurrency(stats.media);
        }

        // Atualizar tabela
        function updateTable(expenses) {
            const tbody = document.getElementById('expensesBody');
            tbody.innerHTML = '';

            expenses.forEach((expense, index) => {
                const row = document.createElement('tr');
                const dataFormatada = formatDate(expense.data);
                const valorFormatado = formatCurrency(expense.valor);
                const categoriaClass = getCategoriaClass(expense.categoria);

                row.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${escapeHtml(expense.descricao)}</td>
                    <td><strong>${valorFormatado}</strong></td>
                    <td><span class="badge ${categoriaClass}">${escapeHtml(expense.categoria || 'N/A')}</span></td>
                    <td><span class="badge badge-subcategoria">${escapeHtml(expense.subcategoria || 'N/A')}</span></td>
                    <td>${formatTags(expense.tags)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="editExpense(${index})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-icon btn-delete" onclick="deleteExpense(${index})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Atualizar pagina√ß√£o
        function updatePagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            const { page, pages, total } = pagination;
            const start = (page - 1) * currentLimit + 1;
            const end = Math.min(page * currentLimit, total);

            paginationDiv.innerHTML = `
                <button onclick="goToPage(1)" ${page === 1 ? 'disabled' : ''}>¬´ Primeira</button>
                <button onclick="goToPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>‚Äπ Anterior</button>
                <span class="page-info">${start}-${end} de ${total}</span>
                <button onclick="goToPage(${page + 1})" ${page >= pages ? 'disabled' : ''}>Pr√≥xima ‚Ä∫</button>
                <button onclick="goToPage(${pages})" ${page >= pages ? 'disabled' : ''}>√öltima ¬ª</button>
            `;
        }

        // Popular op√ß√µes de filtros
        function populateFilterOptions(expenses) {
            const categorias = [...new Set(expenses.map(e => e.categoria).filter(Boolean))].sort();
            const subcategorias = [...new Set(expenses.map(e => e.subcategoria).filter(Boolean))].sort();

            const categoriaSelect = document.getElementById('filterCategoria');
            const subcategoriaSelect = document.getElementById('filterSubcategoria');

            // Manter sele√ß√£o atual
            const currentCategoria = categoriaSelect.value;
            const currentSubcategoria = subcategoriaSelect.value;

            categoriaSelect.innerHTML = '<option value="">Todas</option>';
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === currentCategoria) option.selected = true;
                categoriaSelect.appendChild(option);
            });

            subcategoriaSelect.innerHTML = '<option value="">Todas</option>';
            subcategorias.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                if (sub === currentSubcategoria) option.selected = true;
                subcategoriaSelect.appendChild(option);
            });
        }

        // Ordenar tabela
        function sortTable(column) {
            if (currentSort === column) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = column;
                currentSortOrder = 'asc';
            }
            loadExpenses();
            updateSortIndicators();
        }

        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort) {
                    th.classList.add(currentSortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Navegar p√°ginas
        function goToPage(page) {
            currentPage = page;
            loadExpenses();
        }

        // Editar despesa
        async function editExpense(index) {
            const expense = currentExpenses[index];
            if (!expense) return;

            // Buscar √≠ndice real no CSV
            let realIndex = index;
            try {
                const response = await fetch('/api/expense/find', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: expense.data,
                        descricao: expense.descricao,
                        valor: expense.valor
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    realIndex = result.index;
                }
            } catch (error) {
                console.warn('Erro ao buscar √≠ndice, usando √≠ndice da p√°gina:', error);
            }

            document.getElementById('editIndex').value = realIndex;
            document.getElementById('editData').value = expense.data;
            document.getElementById('editDescricao').value = expense.descricao;
            document.getElementById('editValor').value = expense.valor;
            document.getElementById('editCategoria').value = expense.categoria || '';
            document.getElementById('editSubcategoria').value = expense.subcategoria || '';
            document.getElementById('editTags').value = expense.tags || '';

            document.getElementById('editModal').classList.add('active');
        }

        // Fechar modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Salvar edi√ß√£o
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const data = {
                data: document.getElementById('editData').value,
                descricao: document.getElementById('editDescricao').value,
                valor: parseFloat(document.getElementById('editValor').value),
                categoria: document.getElementById('editCategoria').value,
                subcategoria: document.getElementById('editSubcategoria').value,
                tags: document.getElementById('editTags').value
            };

            try {
                const response = await fetch(`/api/expense/${index}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    closeEditModal();
                    loadExpenses();
                    alert('Despesa atualizada com sucesso!');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert('Erro ao atualizar despesa: ' + error.message);
            }
        });

        // Excluir despesa
        async function deleteExpense(index) {
            if (!confirm('Tem certeza que deseja excluir esta despesa?')) return;

            const expense = currentExpenses[index];
            if (!expense) return;

            // Buscar √≠ndice real no CSV
            let realIndex = index;
            try {
                const response = await fetch('/api/expense/find', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: expense.data,
                        descricao: expense.descricao,
                        valor: expense.valor
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    realIndex = result.index;
                }
            } catch (error) {
                console.warn('Erro ao buscar √≠ndice, usando √≠ndice da p√°gina:', error);
            }

            try {
                const response = await fetch(`/api/expense/${realIndex}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.status === 'success') {
                    loadExpenses();
                    alert('Despesa exclu√≠da com sucesso!');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert('Erro ao excluir despesa: ' + error.message);
            }
        }

        // Exportar CSV
        function exportCSV() {
            const params = new URLSearchParams();
            const search = document.getElementById('filterSearch').value;
            const categoria = document.getElementById('filterCategoria').value;
            const subcategoria = document.getElementById('filterSubcategoria').value;
            const dataInicio = document.getElementById('filterDataInicio').value;
            const dataFim = document.getElementById('filterDataFim').value;
            const valorMin = document.getElementById('filterValorMin').value;
            const valorMax = document.getElementById('filterValorMax').value;

            if (search) params.append('search', search);
            if (categoria) params.append('categoria', categoria);
            if (subcategoria) params.append('subcategoria', subcategoria);
            if (dataInicio) params.append('data_inicio', dataInicio);
            if (dataFim) params.append('data_fim', dataFim);
            if (valorMin) params.append('valor_min', valorMin);
            if (valorMax) params.append('valor_max', valorMax);

            window.location.href = `/api/expenses/export?${params}`;
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('filterSearch').value = '';
            document.getElementById('filterCategoria').value = '';
            document.getElementById('filterSubcategoria').value = '';
            document.getElementById('filterDataInicio').value = '';
            document.getElementById('filterDataFim').value = '';
            document.getElementById('filterValorMin').value = '';
            document.getElementById('filterValorMax').value = '';
            currentPage = 1;
            loadExpenses();
        }

        // Fun√ß√µes auxiliares
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR');
        }

        function formatTags(tags) {
            if (!tags || tags.trim() === '') return '-';
            return tags.split(',').map(tag => 
                `<span class="tag-chip">${escapeHtml(tag.trim())}</span>`
            ).join('');
        }

        function getCategoriaClass(categoria) {
            const map = {
                'CUSTOS FIXOS': 'badge-custos-fixos',
                'CONFORTO': 'badge-conforto',
                'PRAZERES': 'badge-prazeres',
                'CONHECIMENTO': 'badge-conhecimento',
                'METAS': 'badge-metas',
                'LIBERDADE FINANCEIRA': 'badge-liberdade-financeira',
                'CATEGORIZAR': 'badge-categorizar'
            };
            return map[categoria] || 'badge-categorizar';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fechar modal ao clicar fora
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });
    </script>
</body>
</html>

